<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<hr style="margin-top:30px">
<h3>Clôturer et Imprimer un livre</h3>
<input type="text" id="printSearch" placeholder="Nom du livre à imprimer...">
<button class="btn-admin" style="background:#34495e" id="btnPreparePrint">PRÉPARER L'IMPRESSION</button>

<div id="printArea" style="display:none; padding: 40px; font-family: serif; background: white; color: black;">
    <h1 id="pNom" style="text-align:center; font-size: 28pt;">Livre d'Or</h1>
    <h2 id="pSoutitre" style="text-align:center; font-size: 18pt; border-bottom: 2px solid gold; padding-bottom: 20px;"></h2>
    <div id="pMessages" style="margin-top: 30px;"></div>
</div>

<script type="module">
    // ... (garde ton code Firebase précédent) ...

    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    const db = getFirestore();

    document.getElementById('btnPreparePrint').onclick = async () => {
        const nom = document.getElementById('printSearch').value;
        const docRef = doc(db, "deuils", nom);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('pNom').innerText = "In Memoriam : " + data.nom;
            document.getElementById('pSoutitre').innerText = "Livre de Souvenirs - Nécropole Cité des Anges";
            
            const msgSnap = await getDocs(collection(db, "deuils", nom, "messages"));
            let htmlMsg = "";
            msgSnap.forEach(m => {
                const d = m.data();
                htmlMsg += `<div style="margin-bottom:20px; border-bottom:1px dashed #ccc; padding-bottom:10px;">
                    <b style="color:#af944d">${d.auteur} :</b><br>
                    <p style="font-style:italic">"${d.texte}"</p>
                </div>`;
            });
            document.getElementById('pMessages').innerHTML = htmlMsg;

            // Lancer la génération PDF
            const element = document.getElementById('printArea');
            element.style.display = "block"; // Temporairement visible pour le script
            html2pdf().from(element).save(`Livre_Or_${nom}.pdf`).then(() => {
                element.style.display = "none";
            });
        } else {
            alert("Livre introuvable.");
        }
    };
</script>
